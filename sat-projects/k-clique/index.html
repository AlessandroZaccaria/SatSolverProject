<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Graph Clique SAT Checker</title>
    <!-- Tailwind via CDN for rapid prototyping -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/graphology/0.26.0/graphology.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sigma.js/3.0.1/sigma.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/graphology-library/dist/graphology-library.min.js"></script>
</head>

<body class="min-h-screen bg-gradient-to-br from-slate-100 to-slate-200 flex items-center justify-center"
    style="padding: 1.5vh">
    <div class="w-full rounded-2xl shadow-xl bg-white p-8 space-y-6 flex flex-col" style="height: 97vh">
        <header class="text-center">
            <h1 class="text-3xl font-bold tracking-tight text-slate-800">
                Clique SAT&nbsp;Solver
            </h1>
            <p class="mt-2 text-sm text-slate-600">
                Drag‑and‑drop a graph <code>.txt</code> file or click to browse. The
                server will tell you whether the instance is SAT and list the clique
                vertices.
            </p>
        </header>

        <!-- Drop squre -->
        <label id="drop-area" for="file-input" style="height: 100%;"
            class="flex flex-col items-center justify-center w-full border-2 border-dashed border-slate-400 rounded-xl cursor-pointer transition-colors duration-150 ease-in-out hover:border-slate-400 focus:outline-none">
            <input id="file-input" type="file" accept=".txt" class="hidden" />
            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-slate-400 mb-3" fill="none"
                viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round"
                    d="M3 15v4a2 2 0 002 2h14a2 2 0 002-2v-4m-4-4l-4-4m0 0l-4 4m4-4v12" />
            </svg>
            <p class="text-slate-600">
                <span class="font-medium">Drop file</span> or
                <span class="underline">browse</span>
            </p>
            <p class="text-xs text-slate-400 mt-1">Accepted format: .txt</p>
        </label>

        <!-- Result Panel -->
        <div id="result-panel" class="hidden rounded-xl border border-slate-200 p-4 space-y-2"
            style="margin-top: 24px !important; margin-bottom: 0;">
            <p id="status" class="text-base font-medium"></p>
            <ul id="clique-list" class="flex flex-wrap gap-2"></ul>
        </div>
    </div>

    <script>
        const dropArea = document.getElementById("drop-area");
        const fileInput = document.getElementById("file-input");
        const resultPanel = document.getElementById("result-panel");
        const statusText = document.getElementById("status");
        const cliqueList = document.getElementById("clique-list");
        function getColor() {
            return '#' + [...Array(3)]
                .map(() => (128 + Math.floor(Math.random() * 90))
                    .toString(16)
                    .padStart(2, '0'))
                .join('');
        }
        // --- inizio roba dei grafi ---
        function grafi(edges, points, clique = []) {
            const cliqueSet = new Set(clique.map(String));
            const g = new graphology.Graph();
            points.forEach((point, i) => {
                g.addNode(point, { x: Math.cos(Math.PI * 2 * i / points.length), y: Math.sin(Math.PI * 2 * i / points.length), size: 10, label: point, color: cliqueSet.has(String(point)) ? "#ff3333" : getColor() });
            });
            edges.forEach(([u, v]) => {
                const inClique = cliqueSet.has(String(u)) && cliqueSet.has(String(v));
                g.addEdge(u, v, {
                    color: inClique ? "#ff3333" : "#b0b0b0",
                    size: inClique ? 2 : 1,
                });
            });


            /* ---------- renderer ---------- */
            const fa2Settings = graphologyLibrary.layoutForceAtlas2.inferSettings(g);
            graphologyLibrary.layoutForceAtlas2.assign(g, { iterations: 200, settings: fa2Settings })
            const container = document.getElementById("sigma-container");
            const renderer = new Sigma(g, container, { labelThreshold: 0 });

            /* ---------- internal state ---------- */
            let hovered = null;
            let neighbours = null;

            /* ---------- helpers ---------- */
            function setHovered(nodeId) {
                hovered = nodeId || null;
                neighbours = nodeId ? new Set(g.neighbors(nodeId)) : null;
                renderer.refresh({ skipIndexation: true });
            }

            /* ---------- reducers ---------- */
            renderer.setSetting("nodeReducer", (id, attrs) => {
                if (!hovered) return attrs;
                if (id === hovered || neighbours.has(id)) return attrs;
                return { ...attrs, label: "", color: "#e0e0e0" };
            });

            renderer.setSetting("edgeReducer", (eid, attrs) => {
                if (!hovered) return attrs;
                const [s, t] = g.extremities(eid);
                return (s === hovered || t === hovered || neighbours.has(s) || neighbours.has(t))
                    ? attrs
                    : { ...attrs, hidden: true };
            });

            /* ---------- events ---------- */
            renderer.on("enterNode", ({ node }) => setHovered(node));
            renderer.on("leaveNode", () => setHovered(null));
            renderer.on("clickStage", () => setHovered(null)); // reset on empty click
        }
        // --- end of roba dei grafi ---
        // --- helpers ---------------------------------------------------------
        function highlight(on) {
            dropArea.classList.toggle("border-sky-400", on);
            dropArea.classList.toggle("ring-2", on);
            dropArea.classList.toggle("ring-sky-200", on);
        }

        function showGraph(edges, points, clique = []) {
            dropArea.innerHTML = "";
            dropArea.classList.remove("border-dashed");
            const sigma = document.createElement("div");
            sigma.id = "sigma-container";
            sigma.style.height = "100%";
            sigma.style.width = "100%";
            dropArea.appendChild(sigma);
            grafi(edges, points, clique);

        }
        function showResult({ sat, clique, message, edges, points }) {
            statusText.textContent = sat ? "✅ SATISFIABLE" : "❌ UNSATISFIABLE";
            statusText.className = sat
                ? "text-green-600 font-semibold"
                : "text-red-600 font-semibold";
            showGraph(edges, points, clique) // Call the graph function
            // Clear previous list
            cliqueList.innerHTML = "";
            if (sat && clique?.length) {
                clique.forEach((v) => {
                    const li = document.createElement("li");
                    li.textContent = v;
                    li.className =
                        "px-2 py-0.5 rounded-lg bg-sky-100 text-sky-700 text-sm font-mono";
                    cliqueList.appendChild(li);
                });
            }
            if (message) {
                const note = document.createElement("p");
                note.textContent = message;
                note.className = "text-xs text-slate-400";
                cliqueList.after(note);
            }
            resultPanel.classList.remove("hidden");
        }

        function upload(file) {
            const formData = new FormData();
            formData.append("file", file);

            statusText.textContent = "Solving…";
            statusText.className = "text-slate-600 font-medium animate-pulse";
            resultPanel.classList.remove("hidden");
            cliqueList.innerHTML = "";

            fetch("/solve", {
                method: "POST",
                body: formData,
            })
                .then((r) => r.json())
                .then((data) => {
                    showResult(data);
                })
                .catch((err) => {
                    console.error(err);
                    showResult({
                        sat: false,
                        clique: [],
                        message: "Error communicating with server.",
                    });
                });
        }

        // --- event listeners ---
        ["dragenter", "dragover", "dragleave", "drop"].forEach((evt) => {
            dropArea.addEventListener(evt, (e) => {
                e.preventDefault();
                e.stopPropagation();
                highlight(true);
            });
        });

        dropArea.addEventListener("drop", (e) => {
            const files = e.dataTransfer.files;
            if (files.length) {
                upload(files[0]);
            }
        });
        fileInput.addEventListener("change", (e) => {
            upload(e.target.files[0]);
        });
    </script>
</body>

</html>